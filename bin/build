#!/usr/bin/env bash

set -euo pipefail

app=genability-java 

sha=${GITHUB_SHA:-$(git rev-parse HEAD)}
dir=${GITHUB_WORKSPACE:-$(git rev-parse --show-toplevel)}
ref=${GITHUB_REF_NAME:-$(git symbolic-ref --short HEAD)}

branch=${BRANCH_NAME:-$(printf "${ref}" | tr -c '[:alnum:]\n' '-')}

registry="011567534215.dkr.ecr.${AWS_REGION}.amazonaws.com"
repo="${registry}/${app}"

. "${dir}/bin/dispatch.sh"

build_command_login() {
  aws ecr get-login-password | docker login --username AWS --password-stdin "${registry}"
}

build_command_build () {
  export DOCKER_BUILDKIT=1
  docker build "$dir" \
    --file "${dir}/Dockerfile" \
    --cache-from "${repo}:${sha}" \
    --cache-from "${repo}:${branch}" \
    --build-arg BUILDKIT_INLINE_CACHE=1 \
    -t "${repo}:${sha}" \
    -t "${repo}:${branch}"
}

build_command_push () {
  docker push "${repo}:${sha}"
  docker push "${repo}:${branch}"
}

build_command_all () {
  build_command_login
  build_command_build
  build_command_push
}

dispatch build "${@:-all}"
